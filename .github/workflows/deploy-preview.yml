name: PR ë¯¸ë¦¬ë³´ê¸° ë°°í¬

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# GitHub APIì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ì •ì  ì‚¬ì´íŠ¸ ë¹Œë“œ
        run: npm run build
        
      - name: AWS ì¸ì¦ ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
          
      - name: PR ë²ˆí˜¸ ì¶”ì¶œ
        id: pr_number
        run: echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        
      - name: S3 ë¯¸ë¦¬ë³´ê¸° ë²„í‚· ì„¤ì •
        id: preview_bucket
        run: |
          PREVIEW_BUCKET="${{ secrets.AWS_PREVIEW_BUCKET_PREFIX }}-pr-${{ steps.pr_number.outputs.pr_number }}"
          echo "preview_bucket=$PREVIEW_BUCKET" >> $GITHUB_OUTPUT
          echo "preview_url=http://$PREVIEW_BUCKET.s3-website.ap-northeast-2.amazonaws.com" >> $GITHUB_OUTPUT
          
          # ë²„í‚·ì´ ì—†ìœ¼ë©´ ìƒì„±
          if ! aws s3api head-bucket --bucket $PREVIEW_BUCKET 2>/dev/null; then
            # ë²„í‚· ìƒì„±
            aws s3 mb s3://$PREVIEW_BUCKET
            
            # Block Public Access ì„¤ì • ë¹„í™œì„±í™” (ë²„í‚· ë ˆë²¨)
            aws s3api put-public-access-block --bucket $PREVIEW_BUCKET --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
            
            # ì›¹ì‚¬ì´íŠ¸ ì„¤ì •
            aws s3 website s3://$PREVIEW_BUCKET --index-document index.html --error-document 404.html
            
            # ë³´ë‹¤ ê°„ë‹¨í•œ ë²„í‚· ì •ì±… ì„¤ì • (ê³µê°œ ì½ê¸° ì•¡ì„¸ìŠ¤)
            echo '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "PublicReadGetObject",
                  "Effect": "Allow",
                  "Principal": "*",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::'$PREVIEW_BUCKET'/*"
                }
              ]
            }' > bucket-policy.json
            
            aws s3api put-bucket-policy --bucket $PREVIEW_BUCKET --policy file://bucket-policy.json
          fi
          
      - name: S3ì— ë°°í¬
        run: |
          # ACL ì—†ì´ íŒŒì¼ ì—…ë¡œë“œ (ë²„í‚· ì •ì±…ë§Œ ì‚¬ìš©)
          aws s3 sync ./out/ s3://${{ steps.preview_bucket.outputs.preview_bucket }} --delete
          
          # ì½˜í…ì¸  íƒ€ì… ì„¤ì • (ACL ì—†ì´)
          aws s3 cp s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ --recursive --exclude "*" --include "*.html" --content-type "text/html" --metadata-directive REPLACE
          aws s3 cp s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ --recursive --exclude "*" --include "*.css" --content-type "text/css" --metadata-directive REPLACE
          aws s3 cp s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ s3://${{ steps.preview_bucket.outputs.preview_bucket }}/ --recursive --exclude "*" --include "*.js" --content-type "application/javascript" --metadata-directive REPLACE
          
          # ì •ì  ì›¹ì‚¬ì´íŠ¸ ì„¤ì • í™•ì¸
          aws s3api get-bucket-website --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} || aws s3 website s3://${{ steps.preview_bucket.outputs.preview_bucket }} --index-document index.html --error-document 404.html
          
      - name: PRì— ë¯¸ë¦¬ë³´ê¸° URL ëŒ“ê¸€ ë‹¬ê¸°
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo } } = context;
            const preview_url = "${{ steps.preview_bucket.outputs.preview_url }}";
            
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number
            });
            
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
            
            const body = `### ğŸš€ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤\n\në¯¸ë¦¬ë³´ê¸° URL: ${preview_url}\n\ní˜„ì¬ PRì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì´ ìœ„ URLì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: AWS ì¸ì¦ ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
          
      - name: PR ë²ˆí˜¸ ì¶”ì¶œ
        id: pr_number
        run: echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        
      - name: S3 ë¯¸ë¦¬ë³´ê¸° ë²„í‚· ì„¤ì •
        id: preview_bucket
        run: |
          PREVIEW_BUCKET="${{ secrets.AWS_PREVIEW_BUCKET_PREFIX }}-pr-${{ steps.pr_number.outputs.pr_number }}"
          echo "preview_bucket=$PREVIEW_BUCKET" >> $GITHUB_OUTPUT
          
      - name: S3 ë²„í‚· ë¹„ìš°ê¸° ë° ì‚­ì œ
        run: |
          # ë²„í‚·ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if aws s3api head-bucket --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} 2>/dev/null; then
            # ë²„í‚· ë¹„ìš°ê¸°
            aws s3 rm s3://${{ steps.preview_bucket.outputs.preview_bucket }} --recursive
            # ë²„í‚· ì‚­ì œ
            aws s3 rb s3://${{ steps.preview_bucket.outputs.preview_bucket }} --force
          else
            echo "ë¯¸ë¦¬ë³´ê¸° ë²„í‚·ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi 