name: PR ë¯¸ë¦¬ë³´ê¸° ë°°í¬

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# GitHub APIì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ì •ì  ì‚¬ì´íŠ¸ ë¹Œë“œ
        run: npm run build
        
      - name: AWS ì¸ì¦ ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
          
      - name: PR ë²ˆí˜¸ ì¶”ì¶œ
        id: pr_number
        run: echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        
      - name: S3 ë¯¸ë¦¬ë³´ê¸° ë²„í‚· ì„¤ì •
        id: preview_bucket
        run: |
          PREVIEW_BUCKET="${{ secrets.AWS_PREVIEW_BUCKET_PREFIX }}-pr-${{ steps.pr_number.outputs.pr_number }}"
          echo "preview_bucket=$PREVIEW_BUCKET" >> $GITHUB_OUTPUT
          echo "preview_url=http://$PREVIEW_BUCKET.s3-website.ap-northeast-2.amazonaws.com" >> $GITHUB_OUTPUT
      
      # 1. ë²„í‚· ìƒì„± ë‹¨ê³„
      - name: S3 ë²„í‚· ìƒì„± (ì—†ëŠ” ê²½ìš°)
        run: |
          if ! aws s3api head-bucket --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} 2>/dev/null; then
            echo "ìƒˆ ë²„í‚· ìƒì„±: ${{ steps.preview_bucket.outputs.preview_bucket }}"
            aws s3 mb s3://${{ steps.preview_bucket.outputs.preview_bucket }}
          else
            echo "ê¸°ì¡´ ë²„í‚· ì‚¬ìš©: ${{ steps.preview_bucket.outputs.preview_bucket }}"
          fi
          
      # 2. ë²„í‚· ê³µê°œ ì„¤ì •
      - name: ë²„í‚· ê³µê°œ ì•¡ì„¸ìŠ¤ ì„¤ì •
        run: |
          # Block Public Access ì„¤ì • ë¹„í™œì„±í™” (ë²„í‚· ë ˆë²¨)
          aws s3api put-public-access-block --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          echo "ë²„í‚· ê³µê°œ ì•¡ì„¸ìŠ¤ ì„¤ì • ì™„ë£Œ"
          
      # 3. ë²„í‚· ì •ì±… ì„¤ì •
      - name: ë²„í‚· ì •ì±… ì„¤ì •
        run: |
          # ì •í™•í•œ ë²„í‚· ì •ì±… ì„¤ì •
          echo '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::'${{ steps.preview_bucket.outputs.preview_bucket }}'/*"
              }
            ]
          }' > bucket-policy.json
          
          # ì •ì±… íŒŒì¼ ë‚´ìš© í™•ì¸
          echo "ì •ì±… íŒŒì¼ ë‚´ìš©:"
          cat bucket-policy.json
          
          # ë²„í‚· ì •ì±… ì ìš©
          aws s3api put-bucket-policy --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} --policy file://bucket-policy.json
          
          # ì •ì±… ì ìš© í™•ì¸
          echo "ì ìš©ëœ ë²„í‚· ì •ì±…:"
          aws s3api get-bucket-policy --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} --output json
          
      # 4. S3 ì›¹ì‚¬ì´íŠ¸ ì„¤ì • ì—…ë°ì´íŠ¸
      - name: S3 ì›¹ì‚¬ì´íŠ¸ ì„¤ì •
        run: |
          aws s3 website s3://${{ steps.preview_bucket.outputs.preview_bucket }} --index-document index.html --error-document 404.html
          
          echo "ì›¹ì‚¬ì´íŠ¸ ì„¤ì • ì™„ë£Œ"
          
      # 5. ì •ì  íŒŒì¼ ë°°í¬
      - name: S3ì— íŒŒì¼ ë°°í¬
        run: |
          # ACL ì—†ì´ íŒŒì¼ ì—…ë¡œë“œ (ë²„í‚· ì •ì±…ìœ¼ë¡œ ê³µê°œ ì ‘ê·¼ í—ˆìš©)
          aws s3 sync ./out/ s3://${{ steps.preview_bucket.outputs.preview_bucket }} --delete
          
          echo "ë°°í¬ ì™„ë£Œ - ë¯¸ë¦¬ë³´ê¸° URL: ${{ steps.preview_bucket.outputs.preview_url }}"
          
      - name: PRì— ë¯¸ë¦¬ë³´ê¸° URL ëŒ“ê¸€ ë‹¬ê¸°
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo } } = context;
            const preview_url = "${{ steps.preview_bucket.outputs.preview_url }}";
            
            const timestamp = new Date().toISOString();
            const body = `### ğŸš€ ë¯¸ë¦¬ë³´ê¸° í™˜ê²½ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤ (${timestamp})\n\në¯¸ë¦¬ë³´ê¸° URL: ${preview_url}\n\ní˜„ì¬ PRì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì´ ìœ„ URLì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body
            });

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: AWS ì¸ì¦ ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
          
      - name: PR ë²ˆí˜¸ ì¶”ì¶œ
        id: pr_number
        run: echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        
      - name: S3 ë¯¸ë¦¬ë³´ê¸° ë²„í‚· ì„¤ì •
        id: preview_bucket
        run: |
          PREVIEW_BUCKET="${{ secrets.AWS_PREVIEW_BUCKET_PREFIX }}-pr-${{ steps.pr_number.outputs.pr_number }}"
          echo "preview_bucket=$PREVIEW_BUCKET" >> $GITHUB_OUTPUT
          
      - name: S3 ë²„í‚· ë¹„ìš°ê¸° ë° ì‚­ì œ
        run: |
          # ë²„í‚·ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if aws s3api head-bucket --bucket ${{ steps.preview_bucket.outputs.preview_bucket }} 2>/dev/null; then
            # ë²„í‚· ë¹„ìš°ê¸°
            aws s3 rm s3://${{ steps.preview_bucket.outputs.preview_bucket }} --recursive
            # ë²„í‚· ì‚­ì œ
            aws s3 rb s3://${{ steps.preview_bucket.outputs.preview_bucket }} --force
          else
            echo "ë¯¸ë¦¬ë³´ê¸° ë²„í‚·ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi 